#!/usr/bin/env python2

# TODO: test handling of spaces in filenames

import optparse
import os
import os.path
import sys

def output_makefile(srcdir, datadir):
    srcdir = os.path.abspath(srcdir)
    datadir = os.path.abspath(datadir)
    xml_install_dir = os.path.join(datadir, 'xml', 'glapi')
    xml_src_dir = os.path.join(srcdir, 'glapi')
    with open('Makefile', 'w') as f:
        f.write("""\
# glapi makefile
# Automatically generated by ./configure

XML_SRC_DIR = {xml_src_dir}
XML_INSTALL_DIR = {xml_install_dir}

all: # Nothing to do

clean: # Nothing to do

install:
\tmkdir -p ${{XML_INSTALL_DIR}}
\tcp ${{XML_SRC_DIR}}/*.xml ${{XML_INSTALL_DIR}}
""".format(xml_src_dir = xml_src_dir, xml_install_dir = xml_install_dir))
        if sys.platform.startswith('linux'):
            # TODO: pkgconfig
            pass
        f.write("""\
.PHONY: all clean install

""")

if __name__ == '__main__':
    parser = optparse.OptionParser(usage='Configure glapi for the current system')
    parser.add_option(
        '--prefix', dest='prefix', metavar='prefix',
        help='install architecture-independent files in PREFIX [/usr/local]')
    parser.add_option(
        '--datadir', dest='datadir', metavar='datatir',
        help='read-only architecture-independent data [PREFIX/share]')
    options, args = parser.parse_args()
    if args:
        parser.print_help()
        exit(1)
    prefix = options.prefix or '/usr/local'
    datadir = options.datadir or os.path.join(prefix, 'share')
    os.chdir(os.path.dirname(__file__))
    output_makefile('.', datadir)
    print "Run 'make install' to install glapi files"
